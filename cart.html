<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Applied Robotics - Heart Monitors</title>
        <link rel="icon" type="image/x-icon" href="/img/icon1.png">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
        <link rel="stylesheet" href="style.css">
        <script src="https://js.stripe.com/v3/"></script>
    </head>

    <body>
        <section id="header">
            <a href="#"><img src="img/winrx_logo.png" class="logo" alt=""></a>

            <div>
                <ul id="navbar">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="shop.html">Shop</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li id="lg-bag"><a class="active" href="cart.html"><i class='bx bx-shopping-bag' ></i></a></li>
                    <a href="#" id="close"><i class='bx bx-x'></i></a>
                </ul>
            </div>
            <div id="mobile">
                <a href="cart.html"><i class='bx bx-shopping-bag' ></i></a>
                <i id="bar" class='bx bx-menu'></i>
            </div>
        </section>

        <section id="page-header" class="about-header">
            <h2>#shopping_cart</h2>
            <p>Your healthcare technology cart</p>
        </section>

        <section id="cart" class="section-p1">
            <table width="100%">
                <thead>
                    <tr>
                        <td>Remove</td>
                        <td>Image</td>
                        <td>Product</td>
                        <td>Price</td>
                        <td>Quantity</td>
                        <td>Subtotal</td>
                    </tr>
                </thead>
                <tbody id="cart-items">
                    <!-- Cart items will be loaded dynamically -->
                </tbody>
            </table>
            <div id="empty-cart" style="display: none; text-align: center; padding: 50px;">
                <h3>Your cart is empty</h3>
                <p>Add some products to your cart to continue shopping.</p>
                <button class="normal" onclick="window.location.href='shop.html'">Continue Shopping</button>
            </div>
        </section>

        <section id="cart-add" class="section-p1">
            <div id="coupon">
                <h3>Apply Coupon</h3>
                <div>
                    <input type="text" placeholder="Enter Your Coupon">
                    <button class="normal">Apply</button>
                </div>
            </div>

            <div id="subtotal">
                <h3>Cart Total</h3>
                <table>
                    <tr>
                        <td>Cart Subtotal</td>
                        <td id="cart-subtotal">$249.99</td>
                    </tr>
                    <tr>
                        <td>Shipping</td>
                        <td>Free</td>
                    </tr>
                    <tr>
                        <td><strong>Total</strong></td>
                        <td><strong id="cart-total">$249.99</strong></td>
                    </tr>
                </table>
                <button class="normal" onclick="redirectToStripe()">Proceed to checkout</button>
            </div>
        </section>

        <footer class="section-p1">
            <div class="col">
                <img class="logo" src="./img/winrx_logo.png" alt="">
                <h4>Contact</h4>
                <p><strong>Address:</strong> Box 205 Stn. Fort Langley, Langley, BC, V1M 2R5</p>
                <p><strong>Phone:</strong> (778) 949 - 6264</p>
                <p><strong>Hours:</strong> 9:00 - 17:00, Mon - Fri PST</p>
                <div class="follow">
                    <h4>Follow us</h4>
                    <div class="icon">
                        <i class='bx bxl-facebook'></i>
                        <i class='bx bxl-twitter' ></i>
                        <i class='bx bxl-instagram' ></i>
                        <i class='bx bxl-pinterest-alt' ></i>
                        <i class='bx bxl-youtube' ></i>
                    </div>
                </div>
            </div>

            <div class="col">
                <h4>About</h4>
                <a href="#">About us</a>
                <a href="#">Devlivery Information</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms & Conditions</a>
                <a href="#">Contact Us</a>
            </div>

            <div class="col">
                <h4>My Account</h4>
                <a href="#">Sign In</a>
                <a href="#">View Cart</a>
                <a href="#">My Wishlist</a>
                <a href="#">Track My Order</a>
                <a href="#">Help</a>
            </div>

            <div class="col install">
                <h4>Install App</h4>
                <p>From App Store or Google Play</p>
                <div class="row">
                    <img src="./img/pay/app.jpg" alt="">
                    <img src="./img/pay/play.jpg" alt="">
                </div>
                <p>Secured Payment Gateways</p>
                <img src="./img/pay/pay.png" alt="">
            </div>

                         <div class="copyright">
                 <p>Â© 2024, Applied Robotics - Healthcare Technology Solutions</p>
             </div>
        </footer>

        <script src="script.js"></script>
        <script>
            let cart = [];

            function loadCart() {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                displayCart();
                updateCartTotal();
            }

            function displayCart() {
                const cartItemsContainer = document.getElementById('cart-items');
                const emptyCartDiv = document.getElementById('empty-cart');
                
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '';
                    emptyCartDiv.style.display = 'block';
                    return;
                }
                
                emptyCartDiv.style.display = 'none';
                
                cartItemsContainer.innerHTML = cart.map((item, index) => `
                    <tr>
                        <td><i class='bx bx-x-circle' onclick="removeItem(${index})" style="cursor: pointer; color: #ff6b6b;"></i></td>
                        <td><img src="${item.image}" alt="${item.name}" style="width: 80px; height: 80px; object-fit: cover;"></td>
                        <td>${item.name}${item.size ? ` (${item.size})` : ''}</td>
                        <td>$${(item.price / 100).toFixed(2)}</td>
                        <td><input type="number" value="${item.quantity}" min="1" max="5" onchange="updateQuantity(${index}, this.value)"></td>
                        <td>$${((item.price * item.quantity) / 100).toFixed(2)}</td>
                    </tr>
                `).join('');
            }

            function removeItem(index) {
                cart.splice(index, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }

            function updateQuantity(index, newQuantity) {
                const quantity = parseInt(newQuantity);
                if (quantity > 0 && quantity <= 5) {
                    cart[index].quantity = quantity;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartTotal();
                    displayCart();
                }
            }

            function updateCartTotal() {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const totalFormatted = (total / 100).toFixed(2);
                
                document.getElementById('cart-subtotal').textContent = `$${totalFormatted}`;
                document.getElementById('cart-total').textContent = `$${totalFormatted}`;
            }

            function redirectToStripe() {
                if (cart.length === 0) {
                    alert('Your cart is empty. Please add some items before checkout.');
                    return;
                }

                // Initialize Stripe with your publishable key
                const stripe = Stripe('pk_test_51RrQMWAicdvqG4FAOpp4PrpbUysLzY6lBuJNyzBJwGJBFijQHRFhn3Yj1CgwjTSpqDMMDzHsVO8sZjUI56I4Ogvc008L14DcCZ');

                // Create checkout session with all cart items
                fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: cart.map(item => ({
                            name: item.name,
                            price: item.price,
                            quantity: item.quantity,
                            size: item.size || null
                        }))
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(session => {
                    console.log('Session response:', session);
                    if (!session || !session.id) {
                        throw new Error('No session ID received from server');
                    }
                    // Redirect to Stripe checkout
                    return stripe.redirectToCheckout({
                        sessionId: session.id
                    });
                })
                .then(result => {
                    // This will only execute if redirectToCheckout fails
                    if (result && result.error) {
                        console.error('Stripe redirect error:', result.error);
                        alert('Payment redirect failed: ' + result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Checkout session creation failed: ' + error.message);
                });
            }

            // Load cart when page loads
            document.addEventListener('DOMContentLoaded', loadCart);
        </script>
    </body>
</html>
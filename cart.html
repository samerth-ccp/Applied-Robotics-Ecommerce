<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Applied Robotics - Heart Monitors</title>
        <link rel="icon" type="image/x-icon" href="/img/icon1.png">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
        <link rel="stylesheet" href="style.css">
        <script src="https://js.stripe.com/v3/"></script>
    </head>

    <body>
        <section id="header">
            <a href="#"><img src="img/winrx_logo.png" class="logo" alt=""></a>

            <div>
                <ul id="navbar">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="shop.html">Shop</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li id="lg-bag"><a class="active" href="cart.html"><i class='bx bx-shopping-bag' ></i></a></li>
                    <a href="#" id="close"><i class='bx bx-x'></i></a>
                </ul>
            </div>
            <div id="mobile">
                <a href="cart.html"><i class='bx bx-shopping-bag' ></i></a>
                <i id="bar" class='bx bx-menu'></i>
            </div>
        </section>

        <section id="page-header" class="about-header">
            <h2>#shopping_cart</h2>
            <p>Your healthcare technology cart</p>
        </section>

        <section id="cart" class="section-p1">
            <table width="100%">
                <thead>
                    <tr>
                        <td>Remove</td>
                        <td>Image</td>
                        <td>Product</td>
                        <td>Price</td>
                        <td>Quantity</td>
                        <td>Subtotal</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><i class='bx bx-x-circle'></i></td>
                        <td><img src="./img/heart_monitor.jpg" alt=""></td>
                        <td>Auro Ring Heart Rate Monitor</td>
                        <td>$249.99</td>
                        <td><input type="number" id="quantity" value="1" min="1" onchange="updateTotal()"></td>
                        <td id="subtotal">$249.99</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="cart-add" class="section-p1">
            <div id="coupon">
                <h3>Apply Coupon</h3>
                <div>
                    <input type="text" placeholder="Enter Your Coupon">
                    <button class="normal">Apply</button>
                </div>
            </div>

            <div id="subtotal">
                <h3>Cart Total</h3>
                <table>
                    <tr>
                        <td>Cart Subtotal</td>
                        <td id="cart-subtotal">$249.99</td>
                    </tr>
                    <tr>
                        <td>Shipping</td>
                        <td>Free</td>
                    </tr>
                    <tr>
                        <td><strong>Total</strong></td>
                        <td><strong id="cart-total">$249.99</strong></td>
                    </tr>
                </table>
                <button class="normal" onclick="redirectToStripe()">Proceed to checkout</button>
            </div>
        </section>

        <footer class="section-p1">
            <div class="col">
                <img class="logo" src="./img/winrx_logo.png" alt="">
                <h4>Contact</h4>
                <p><strong>Address:</strong> Box 205 Stn. Fort Langley, Langley, BC, V1M 2R5</p>
                <p><strong>Phone:</strong> (778) 949 - 6264</p>
                <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
                <div class="follow">
                    <h4>Follow us</h4>
                    <div class="icon">
                        <i class='bx bxl-facebook'></i>
                        <i class='bx bxl-twitter' ></i>
                        <i class='bx bxl-instagram' ></i>
                        <i class='bx bxl-pinterest-alt' ></i>
                        <i class='bx bxl-youtube' ></i>
                    </div>
                </div>
            </div>

            <div class="col">
                <h4>About</h4>
                <a href="#">About us</a>
                <a href="#">Devlivery Information</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Terms & Conditions</a>
                <a href="#">Contact Us</a>
            </div>

            <div class="col">
                <h4>My Account</h4>
                <a href="#">Sign In</a>
                <a href="#">View Cart</a>
                <a href="#">My Wishlist</a>
                <a href="#">Track My Order</a>
                <a href="#">Help</a>
            </div>

            <div class="col install">
                <h4>Install App</h4>
                <p>From App Store or Google Play</p>
                <div class="row">
                    <img src="./img/pay/app.jpg" alt="">
                    <img src="./img/pay/play.jpg" alt="">
                </div>
                <p>Secured Payment Gateways</p>
                <img src="./img/pay/pay.png" alt="">
            </div>

                         <div class="copyright">
                 <p>Â© 2024, Applied Robotics - Healthcare Technology Solutions</p>
             </div>
        </footer>

        <script src="script.js"></script>
        <script>
            function updateTotal() {
                const quantity = parseInt(document.getElementById('quantity').value);
                const price = 249.99;
                const total = quantity * price;

                document.getElementById('subtotal').textContent = `$${total.toFixed(2)}`;
                document.getElementById('cart-subtotal').textContent = `$${total.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
            }

            function redirectToStripe() {
                // Get the current quantity from the cart
                const quantity = parseInt(document.getElementById('quantity').value);

                // Initialize Stripe with your publishable key
                const stripe = Stripe('pk_test_51RrQMWAicdvqG4FAOpp4PrpbUysLzY6lBuJNyzBJwGJBFijQHRFhn3Yj1CgwjTSpqDMMDzHsVO8sZjUI56I4Ogvc008L14DcCZ');

                // Create checkout session with the actual quantity
                fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: [{
                            name: 'Auro Ring Heart Rate Monitor',
                            price: 24999, // Price in cents ($249.99)
                            quantity: quantity
                        }]
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(session => {
                    console.log('Session response:', session);
                    if (!session || !session.id) {
                        throw new Error('No session ID received from server');
                    }
                    // Redirect to Stripe checkout
                    return stripe.redirectToCheckout({
                        sessionId: session.id
                    });
                })
                .then(result => {
                    // This will only execute if redirectToCheckout fails
                    if (result && result.error) {
                        console.error('Stripe redirect error:', result.error);
                        alert('Payment redirect failed: ' + result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Checkout session creation failed: ' + error.message);
                });
            }
        </script>
    </body>
</html>